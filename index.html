<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Buckeye Hunter Hub ‚Äì Hunt Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- SunCalc -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100vh; }

    /* Zoom stays top-left (default) */
    .leaflet-control-zoom { margin-top: 10px; }
    /* Push draw toolbar down so it doesn‚Äôt overlap zoom */
    .leaflet-control-container .leaflet-draw { margin-top: 58px; }
    /* Layers control bottom-left spacing */
    .leaflet-bottom.leaflet-left .leaflet-control { margin: 0 0 12px 12px; }

    /* Bottom-right toolbar */
    .toolbar {
      position: fixed;
      bottom: 12px; right: 12px; z-index: 1000;
      background: #fff; border-radius: 12px; padding: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
      max-width: min(96vw, 740px);
    }
    .toolbar button, .toolbar label, .toolbar select {
      margin: 0; padding: 6px 10px; cursor: pointer;
      border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;
    }
    .toolbar input[type="file"] { display: none; }

    /* Marker palette */
    .palette {
      display: flex; gap: 6px; overflow-x: auto; padding-bottom: 2px;
      scrollbar-width: thin;
    }
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border:1px solid #ddd; border-radius: 999px; background:#fff;
      white-space: nowrap;
    }
    .emoji { font-size: 18px; line-height: 1; }

    /* Legal Light (top-right) */
    .panel {
      position: fixed; top: 12px; right: 12px; z-index: 900;
      background: #fff; border-radius: 12px; padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2);
      max-width: 280px;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .panel h3 { margin: 0 0 6px; font-size: 15px; }

    /* Markers list (left) */
    .list {
      position: fixed; left: 12px; bottom: 12px; z-index: 950;
      background:#fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
      max-height: 38vh; width: 280px; overflow: hidden; display: flex; flex-direction: column;
    }
    .list header {
      display:flex; align-items:center; justify-content: space-between; gap:8px;
      padding: 8px 10px; border-bottom:1px solid #eee; font-weight: 600;
    }
    .list .items { overflow-y: auto; }
    .row {
      display:flex; align-items:center; justify-content: space-between; gap:8px;
      padding:8px 10px; border-bottom:1px solid #f3f3f3; cursor:pointer;
    }
    .row:hover { background:#fafafa; }
    .row .left { display:flex; align-items:center; gap:8px; }
    .muted { color:#666; font-size:12px; }

    /* Locate + Fullscreen-open buttons (top-left under zoom/draw) */
    .quick {
      position: fixed; left: 12px; top: 110px; z-index: 950;
      display:flex; gap:8px; flex-direction: column;
    }
    .quick button {
      background:#fff; border:1px solid #ddd; border-radius: 999px;
      padding:8px 12px; box-shadow:0 2px 8px rgba(0,0,0,.15); cursor:pointer;
      font:14px system-ui;
    }

    /* Error banner */
    .err {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 0; z-index: 2000; background:#b91c1c; color:#fff;
      padding: 6px 10px; border-radius: 8px 8px 0 0; font: 13px system-ui;
      display: none; max-width: 92vw;
    }

    @media (max-width: 640px) {
      .panel { top: 58px; right: 8px; max-width: 88vw; }
      .list { left: 8px; right: 8px; width: auto; bottom: 90px; max-height: 30vh; }
      .toolbar { left: 8px; right: 8px; bottom: 8px; justify-content: center; }
      .quick { top: 96px; left: 8px; }
      .leaflet-control-container .leaflet-draw { margin-top: 54px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Quick actions -->
  <div class="quick">
    <button id="btnLocate" title="Use my location">üìç Locate</button>
    <button id="btnOpenTab" title="Open map in a new tab">‚ÜóÔ∏è Open Fullscreen</button>
  </div>

  <!-- Markers list -->
  <div class="list" id="markerList">
    <header>
      <div>Markers</div>
      <div><button id="btnClearMarkers" title="Remove all markers">Clear</button></div>
    </header>
    <div class="items" id="markerItems"></div>
  </div>

  <!-- Bottom-right toolbar -->
  <div class="toolbar">
    <div class="palette" title="Tap a type, then tap the map to place">
      <button class="chip" data-type="scrape"><span class="emoji">ü¶å</span> Scrape</button>
      <button class="chip" data-type="stand"><span class="emoji">üéØ</span> Stand</button>
      <button class="chip" data-type="camera"><span class="emoji">üì∑</span> Camera</button>
      <button class="chip" data-type="rub"><span class="emoji">ü™µ</span> Rub</button>
    </div>

    <select id="areaSelect" title="Hunting area"><option value="default">Default Area</option></select>
    <button id="btnNewArea" title="Create new hunting area">New Area</button>
    <button id="btnSaveArea" title="Save current area">Save Area</button>

    <button id="btnMeasure" title="Measure distance (click 2 points)">Measure</button>
    <button id="btnExport" title="Download drawings + markers">Export</button>
    <button id="btnClear" title="Clear drawings + markers">Clear</button>
    <label for="fileImport" title="Import a JSON/GeoJSON file">Import</label>
    <input type="file" id="fileImport" accept=".geojson,.json,application/geo+json,application/json"/>
    <button id="btnFull" title="Toggle fullscreen">Fullscreen</button>
  </div>

  <!-- Top-right Legal Light -->
  <div class="panel">
    <h3>Legal Light</h3>
    <div id="sunrise"></div>
    <div id="sunset"></div>
    <div id="civilDawn"></div>
    <div id="civilDusk"></div>
    <div id="dayLength"></div>
  </div>

  <!-- Error banner -->
  <div class="err" id="err"></div>

  <script>
    // Simple error banner for quick diagnosis
    window.addEventListener('error', (e) => {
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = 'Error: ' + (e.message || 'script error');
      console.error(e.error || e.message);
    });

    // ---- Map ----
    const map = L.map('map').setView([40.4173, -82.9071], 6);
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ---- Draw Layer ----
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    map.addControl(new L.Control.Draw({ position:'topleft', edit:{ featureGroup: drawnItems }, draw:{ circle:false } }));

    // ---- Custom Markers ----
    const markersLayer = L.featureGroup().addTo(map);
    const markerTypes = {
      scrape: { label: 'Scrape', emoji: 'ü¶å' },
      stand:  { label: 'Stand',  emoji: 'üéØ' },
      camera: { label: 'Camera', emoji: 'üì∑' },
      rub:    { label: 'Rub',    emoji: 'ü™µ' }
    };
    function makeDivIcon(emoji) {
      return L.divIcon({
        className: 'bhh-divicon',
        html: `<div style="background:#fff;border:1px solid #ccc;border-radius:12px;padding:2px 6px;box-shadow:0 1px 4px rgba(0,0,0,.2);font-size:18px;line-height:1">${emoji}</div>`,
        iconSize: [28,28], iconAnchor: [14,14]
      });
    }

    // ---- Areas (localStorage) ----
    const STORAGE_AREAS = 'bhh_areas_v1';
    const areaSelect = document.getElementById('areaSelect');
    const btnNewArea = document.getElementById('btnNewArea');
    const btnSaveArea = document.getElementById('btnSaveArea');

    function loadAreas(){ try { return JSON.parse(localStorage.getItem(STORAGE_AREAS)) || { default:{} }; } catch { return { default:{} }; } }
    function saveAreas(a){ localStorage.setItem(STORAGE_AREAS, JSON.stringify(a)); }
    function refreshAreaDropdown(a, current){
      areaSelect.innerHTML = '';
      Object.keys(a).forEach(name => {
        const opt = document.createElement('option'); opt.value=name; opt.textContent=name;
        if (name===current) opt.selected = true; areaSelect.appendChild(opt);
      });
    }
    let areas = loadAreas(); if (!areas.default) areas.default = {};
    refreshAreaDropdown(areas, 'default');

    function serializeMarkers(){
      const list=[]; markersLayer.eachLayer(m => { const {type,note}=m.options||{}; const {lat,lng}=m.getLatLng(); list.push({type, note:note||'', lat, lng}); });
      return list;
    }
    function deserializeMarkers(list){
      markersLayer.clearLayers();
      (list||[]).forEach(m=>{
        const ic = makeDivIcon((markerTypes[m.type]||{}).emoji || 'üìç');
        L.marker([m.lat,m.lng], {icon:ic, type:m.type, note:m.note||''})
          .addTo(markersLayer)
          .bindPopup(`<b>${(markerTypes[m.type]||{}).label||'Marker'}</b><br>${m.note||''}`);
      });
      renderMarkerList();
    }

    function applyArea(name){
      const a = areas[name] || {};
      drawnItems.clearLayers();
      if (a.drawings) L.geoJSON(a.drawings, { onEachFeature:(_,l)=>drawnItems.addLayer(l) });
      deserializeMarkers(a.markers);
      if (a.view) map.setView([a.view.lat, a.view.lng], a.view.z);
    }
    function saveCurrentArea(name){
      const c = map.getCenter();
      areas[name] = { drawings: drawnItems.toGeoJSON(), markers: serializeMarkers(), view:{lat:c.lat,lng:c.lng,z:map.getZoom()} };
      saveAreas(areas); refreshAreaDropdown(areas, name); alert(`Saved area: ${name}`);
    }
    applyArea('default');

    btnNewArea.onclick = () => {
      const name = prompt('Name this hunting area:'); if (!name) return;
      if (areas[name]) return alert('That name already exists.');
      areas[name] = {}; saveAreas(areas); refreshAreaDropdown(areas, name);
      drawnItems.clearLayers(); markersLayer.clearLayers(); renderMarkerList();
    };
    btnSaveArea.onclick = () => saveCurrentArea(areaSelect.value);
    areaSelect.onchange = () => applyArea(areaSelect.value);

    // Legacy temp drawings save (no longer primary)
    const STORAGE_DRAWINGS = 'bhh_drawings_tmp';
    function saveAll(){ localStorage.setItem(STORAGE_DRAWINGS, JSON.stringify(drawnItems.toGeoJSON())); }
    function restoreLegacy(){ const raw = localStorage.getItem(STORAGE_DRAWINGS); if (raw) L.geoJSON(JSON.parse(raw), { onEachFeature:(_,l)=>drawnItems.addLayer(l) }); }
    map.on(L.Draw.Event.CREATED, e => { drawnItems.addLayer(e.layer); saveAll(); });
    map.on(L.Draw.Event.EDITED, saveAll);
    map.on(L.Draw.Event.DELETED, saveAll);

    // ---- Data layers: try LOCAL first (Wix-friendly), then fall back to state services ----
    const publicLandsLayer = L.geoJSON(null, { style:{ color:'#8b5cf6', weight:2, fillOpacity:0.2 } });
    const countiesLayer    = L.geoJSON(null, { style:{ color:'#555', weight:1, fill:false } });

    const LOCAL_ODNR  = './ohio_public_hunting.geojson';
    const LOCAL_COUNT = './ohio_counties.geojson';
    const ODNR_URL = 'https://gis2.ohiodnr.gov/ArcGIS/rest/services/OIT_Services/DNR_Fed_Lands_Nav_Base/MapServer/2/query?where=1=1&outFields=*&f=geojson';
    const ODOT_URL = 'https://gis.dot.state.oh.us/arcgis/rest/services/Basemap/ODOT_Basemap/MapServer/165/query?where=1=1&outFields=County_Name&f=geojson';

    function loadGeoJSONFirstLocal(layer, localURL, remoteURL, tag){
      fetch(localURL)
        .then(r => { if (!r.ok) throw new Error('local missing'); return r.json(); })
        .then(j => layer.addData(j))
        .catch(() => fetch(remoteURL)
          .then(r => r.json())
          .then(j => layer.addData(j))
          .catch(err => { console.warn(tag+' load failed:', err); showErr(tag+' failed to load'); }));
    }
    function showErr(msg){
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = msg;
      setTimeout(()=>{ el.style.display='none'; }, 6000);
    }

    loadGeoJSONFirstLocal(publicLandsLayer, LOCAL_ODNR, ODNR_URL, 'Public Lands');
    loadGeoJSONFirstLocal(countiesLayer,    LOCAL_COUNT, ODOT_URL, 'Counties');

    // ---- Layers control ----
    const baseMaps = { 'OpenStreetMap': osm };
    const overlays = {
      'Public Hunting Lands': publicLandsLayer,
      'Ohio Counties': countiesLayer,
      'My Drawings': drawnItems,
      'My Markers': markersLayer
    };
    L.control.layers(baseMaps, overlays, { position: 'bottomleft' }).addTo(map);

    // ---- Legal Light ----
    function updateSun(){
      const c = map.getCenter(), now = new Date(), t = SunCalc.getTimes(now, c.lat, c.lng);
      const fmt = d => d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '‚Äî';
      document.getElementById('sunrise').textContent   = "Sunrise: " + fmt(t.sunrise);
      document.getElementById('sunset').textContent    = "Sunset: "  + fmt(t.sunset);
      document.getElementById('civilDawn').textContent = "Civil dawn: " + fmt(t.dawn);
      document.getElementById('civilDusk').textContent = "Civil dusk: " + fmt(t.dusk);
      const mins = (t.sunset - t.sunrise) / 60000;
      document.getElementById('dayLength').textContent = "Day length: " + Math.floor(mins/60) + "h " + (mins%60|0) + "m";
    }
    updateSun(); map.on('moveend', updateSun);

    // ---- IO buttons ----
    document.getElementById('btnExport').onclick = () => {
      const data = { drawings: drawnItems.toGeoJSON(), markers: serializeMarkers() };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/geo+json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'buckeyehunterhub-export.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
    document.getElementById('btnClear').onclick = () => {
      drawnItems.clearLayers(); markersLayer.clearLayers(); renderMarkerList(); saveAll();
    };
    document.getElementById('fileImport').onchange = ev => {
      const f = ev.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (obj.type === 'FeatureCollection' || obj.type === 'Feature') {
            L.geoJSON(obj, { onEachFeature:(_,l)=>drawnItems.addLayer(l) });
          } else {
            if (obj.drawings) L.geoJSON(obj.drawings, { onEachFeature:(_,l)=>drawnItems.addLayer(l) });
            if (obj.markers) deserializeMarkers(obj.markers);
          }
          saveAll();
        } catch { alert('Invalid JSON/GeoJSON'); }
      };
      reader.readAsText(f); ev.target.value = '';
    };
    document.getElementById('btnFull').onclick = () => {
      const el = map.getContainer();
      if (!document.fullscreenElement) { el.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
    };

    // ---- Locate (note: Wix iframe may block; new-tab button helps) ----
    document.getElementById('btnLocate').onclick = () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 15);
          L.circleMarker([latitude, longitude], { radius:8, color:'#2563eb', fillColor:'#3b82f6', fillOpacity:.6 })
            .addTo(map).bindPopup('You are here').openPopup();
        },
        err => alert('Could not get location (browser/host blocked): ' + err.message),
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
      );
    };
    document.getElementById('btnOpenTab').onclick = () => window.open(location.href, '_blank');

    // ---- Measure tool (two clicks) ----
    const btnMeasure = document.getElementById('btnMeasure');
    let measuring = false, measurePts = [], measureLine = null, measureLabel = null;
    function resetMeasure(){
      measurePts = [];
      if (measureLine) { map.removeLayer(measureLine); measureLine = null; }
      if (measureLabel) { map.removeLayer(measureLabel); measureLabel = null; }
    }
    btnMeasure.onclick = () => {
      measuring = !measuring;
      btnMeasure.textContent = measuring ? 'Measuring‚Ä¶ (tap 2 points)' : 'Measure';
      if (!measuring) resetMeasure();
    };
    map.on('click', (e) => {
      if (!measuring) return;
      measurePts.push(e.latlng);
      if (measurePts.length === 2) {
        const dist = map.distance(measurePts[0], measurePts[1]);
        const yards = dist * 1.09361;
        if (measureLine) map.removeLayer(measureLine);
        measureLine = L.polyline(measurePts, { color:'#2563eb', weight:4, dashArray:'6,6' }).addTo(map);
        const mid = L.latLng((measurePts[0].lat + measurePts[1].lat)/2, (measurePts[0].lng + measurePts[1].lng)/2);
        if (measureLabel) map.removeLayer(measureLabel);
        measureLabel = L.marker(mid, { icon: L.divIcon({ className:'', html:
          `<div style="background:#111;color:#fff;padding:4px 8px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.25);font:13px system-ui">
             ${yards.toFixed(0)} yd (${dist.toFixed(0)} m)
           </div>` })}).addTo(map);
        measuring = false; btnMeasure.textContent = 'Measure'; measurePts = [];
      }
    });

    // ---- Marker palette ----
    let activeType = null;
    document.querySelectorAll('.chip').forEach(b => {
      b.onclick = () => {
        activeType = b.getAttribute('data-type');
        document.querySelectorAll('.chip').forEach(x => x.style.background = '#fff');
        b.style.background = '#eef2ff';
      };
    });
    map.on('click', (e) => {
      if (!activeType) return;
      const t = activeType, cfg = markerTypes[t];
      L.marker(e.latlng, { icon: makeDivIcon(cfg.emoji), type: t, note: '' })
        .addTo(markersLayer).bindPopup(`<b>${cfg.label}</b>`);
      renderMarkerList();
    });

    // ---- Marker list ----
    const markerItems = document.getElementById('markerItems');
    const btnClearMarkers = document.getElementById('btnClearMarkers');
    function renderMarkerList(){
      markerItems.innerHTML = '';
      let idx = 0;
      markersLayer.eachLayer(m => {
        const t = m.options.type || 'marker';
        const mt = markerTypes[t] || { label:'Marker', emoji:'üìç' };
        const { lat, lng } = m.getLatLng();
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="left">
            <span class="emoji">${mt.emoji}</span>
            <div>
              <div>${mt.label}</div>
              <div class="muted">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
            </div>
          </div>
          <button data-i="${idx}">Go</button>
        `;
        row.querySelector('button').onclick = () => { map.setView([lat, lng], 17); m.openPopup(); };
        markerItems.appendChild(row);
        idx++;
      });
    }
    btnClearMarkers.onclick = () => { markersLayer.clearLayers(); renderMarkerList(); };

    // Initial legacy restore and list render
    restoreLegacy(); renderMarkerList();
  </script>
</body>
</html>
